{"options":{"viewOn":"products","pipeline":[{"$unwind":{"path":"$items"}},{"$unwind":{"path":"$items.stock"}},{"$group":{"target":{"$sum":"$items.stock.target"},"name":{"$first":"$items.name"},"threshold":{"$sum":"$items.stock.threshold"},"delivery_time":{"$first":"$items.delivery_time"},"amount":{"$sum":"$items.stock.amount"},"ordered":{"$sum":"$items.stock.ordered"},"total_stock_sum":{"$first":"$total_stock_sum"},"_id":{"sku":"$items.sku","locationType":"$items.stock.location.type"},"product_id":{"$first":"$_id"}}},{"$group":{"_id":"$_id.sku","product_id":{"$first":"$product_id"},"sku":{"$first":"$_id.sku"},"name":{"$first":"$name"},"delivery_time":{"$first":"$delivery_time"},"stock":{"$push":{"target":"$target","ordered":"$ordered","location":{"type":"$_id.locationType"},"amount":"$amount","threshold":"$threshold"}},"total_stock_sum":{"$first":"$total_stock_sum"}}},{"$group":{"items":{"$push":{"sku":"$sku","name":"$name","delivery_time":"$delivery_time","stock":"$stock"}},"total_stock_sum":{"$first":"$total_stock_sum"},"_id":"$product_id"}},{"$unwind":{"path":"$total_stock_sum"}},{"$group":{"target":{"$sum":"$total_stock_sum.target"},"ordered":{"$sum":"$total_stock_sum.ordered"},"_id":{"location_type":"$total_stock_sum.location.type","product_id":"$_id"},"items":{"$first":"$items"},"amount":{"$sum":"$total_stock_sum.amount"},"threshold":{"$sum":"$total_stock_sum.threshold"}}},{"$group":{"items":{"$first":"$items"},"total_stock_sum":{"$push":{"location":{"type":"$_id.location_type"},"amount":"$amount","threshold":"$threshold","target":"$target","ordered":"$ordered"}},"_id":"$_id.product_id"}},{"$lookup":{"from":"products","localField":"_id","foreignField":"_id","as":"product"}},{"$unwind":{"path":"$product"}},{"$set":{"product.items":"$items","product.total_stock_sum":"$total_stock_sum"}},{"$replaceRoot":{"newRoot":"$product"}}]},"indexes":[],"collectionName":"products_area_view","type":"view"}